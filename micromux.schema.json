{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/romnn/micromux/blob/main/micromux.schema.json",
  "title": "micromux configuration",
  "type": "object",
  "additionalProperties": true,
  "properties": {
    "version": {
      "description": "Configuration file format version.",
      "anyOf": [
        { "type": "string", "enum": ["1", "v1", "V1", "latest"] },
        { "type": "number", "enum": [1] }
      ]
    },
    "ui": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "width": { "type": "integer", "minimum": 0 }
      }
    },
    "services": {
      "type": "object",
      "additionalProperties": { "$ref": "#/definitions/service" }
    }
  },
  "definitions": {
    "scalar": {
      "anyOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "boolean" }
      ]
    },
    "command": {
      "description": "Command to execute. Either a shell-like string or an argv-like sequence.",
      "anyOf": [
        { "type": "string", "minLength": 1 },
        {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/scalar" }
        }
      ]
    },
    "dependency": {
      "anyOf": [
        { "type": "string", "minLength": 1 },
        {
          "type": "object",
          "additionalProperties": true,
          "required": ["name"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "condition": {
              "type": "string",
              "enum": [
                "service_started",
                "service-started",
                "ServiceStarted",
                "started",
                "service_healthy",
                "service-healthy",
                "ServiceHealthy",
                "healthy",
                "service_completed_successfully",
                "service-completed-successfully",
                "ServiceCompletedSuccessfully",
                "completed"
              ]
            }
          }
        }
      ]
    },
    "env_file_entry": {
      "anyOf": [
        { "type": "string", "minLength": 1 },
        {
          "type": "object",
          "additionalProperties": true,
          "required": ["path"],
          "properties": {
            "path": { "type": "string", "minLength": 1 }
          }
        }
      ]
    },
    "env_file": {
      "anyOf": [
        { "$ref": "#/definitions/env_file_entry" },
        { "type": "array", "items": { "$ref": "#/definitions/env_file_entry" } }
      ]
    },
    "healthcheck": {
      "type": "object",
      "additionalProperties": true,
      "required": ["test"],
      "properties": {
        "test": { "$ref": "#/definitions/command" },
        "start_delay": { "type": "string", "minLength": 1 },
        "startup_delay": { "type": "string", "minLength": 1 },
        "initial_delay": { "type": "string", "minLength": 1 },
        "interval": { "type": "string", "minLength": 1 },
        "timeout": { "type": "string", "minLength": 1 },
        "retries": { "type": "integer", "minimum": 0 }
      }
    },
    "restart": {
      "type": "string",
      "pattern": "^([Aa][Ll][Ww][Aa][Yy][Ss]|[Uu][Nn][Ll][Ee][Ss][Ss][-_][Ss][Tt][Oo][Pp][Pp][Ee][Dd]|[Nn][Ee][Vv][Ee][Rr]|[Nn][Oo]|[Oo][Nn][-_][Ff][Aa][Ii][Ll][Uu][Rr][Ee]([:=\\s]+[0-9]+)?)$"
    },
    "service": {
      "type": "object",
      "additionalProperties": true,
      "required": ["command"],
      "properties": {
        "name": { "type": "string" },
        "command": { "$ref": "#/definitions/command" },
        "working_dir": { "type": "string" },
        "cwd": { "type": "string" },
        "directory": { "type": "string" },
        "env_file": { "$ref": "#/definitions/env_file" },
        "environment": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/scalar" }
        },
        "depends_on": {
          "type": "array",
          "items": { "$ref": "#/definitions/dependency" }
        },
        "healthcheck": { "$ref": "#/definitions/healthcheck" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/scalar" }
        },
        "restart": { "$ref": "#/definitions/restart" },
        "color": { "type": "boolean" }
      }
    }
  }
}
